<!doctype html>
<!-- nav update: 2025-02-14 – unified site header -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Briefing — B.A.S.E.</title>

  <link rel="icon" href="./lib/assets/images/logos/base-logo.png" />
  <link rel="preload" as="image" href="./lib/assets/images/logos/base-logo.png" />
  <link rel="stylesheet" href="./styles/base.css" />
  <link rel="stylesheet" href="./styles/briefing.css" />

  <!-- Your app scripts -->
  <script defer src="./Applications/JSON/app-registry.js"></script>
  <script defer src="./scripts/briefings.js"></script>
  <script defer src="./scripts/data.js"></script>
  <script defer src="./scripts/apps.js"></script>
  <script defer src="./scripts/main.js"></script>
  <script defer src="./scripts/nav.js"></script>
</head>
<body>

  <!-- Primary Navigation (GlassNav v2.1) -->
  <nav class="glassnav" role="navigation" aria-label="Primary">
    <div class="nav-inner">
      <a class="nav-logo" href="./index.html" aria-label="BASE home">
        <img src="./lib/assets/images/logos/base-logo.png" alt="BASE" height="44" width="44" loading="lazy">
      </a>

      <ul class="nav-list">
        <li>
          <a class="nav-link" data-page="home" href="./index.html">
            <span class="label">Home</span>
            <svg class="underline" viewBox="0 0 120 14" preserveAspectRatio="none">
              <path d="M6,10 Q60,2 114,10" />
            </svg>
          </a>
        </li>
        <li>
          <a class="nav-link is-active" data-page="briefing" href="./briefing.html" aria-current="page">
            <span class="label">Briefing</span>
            <svg class="underline" viewBox="0 0 120 14" preserveAspectRatio="none">
              <path d="M6,10 Q60,2 114,10" />
            </svg>
          </a>
        </li>
        <li>
          <a class="nav-link" data-page="applications" href="./applications.html">
            <span class="label">Applications</span>
            <svg class="underline" viewBox="0 0 140 14" preserveAspectRatio="none">
              <path d="M6,10 Q70,2 134,10" />
            </svg>
          </a>
        </li>
        <li>
          <a class="nav-link" data-page="forms" href="./forms.html">
            <span class="label">Forms</span>
            <svg class="underline" viewBox="0 0 90 14" preserveAspectRatio="none">
              <path d="M6,10 Q45,2 84,10" />
            </svg>
          </a>
        </li>
        <li>
          <a class="nav-link" data-page="recoveries" href="./recoveries.html">
            <span class="label">Recoveries</span>
            <svg class="underline" viewBox="0 0 130 14" preserveAspectRatio="none">
              <path d="M6,10 Q65,2 124,10" />
            </svg>
          </a>
        </li>
        <li>
          <a class="nav-link" data-page="directory" href="./directory.html">
            <span class="label">Directory</span>
            <svg class="underline" viewBox="0 0 120 14" preserveAspectRatio="none">
              <path d="M6,10 Q60,2 114,10" />
            </svg>
          </a>
        </li>
        <li>
          <a class="nav-link" data-page="settings" href="./settings.html">
            <span class="label">Settings</span>
            <svg class="underline" viewBox="0 0 105 14" preserveAspectRatio="none">
              <path d="M6,10 Q52,2 99,10" />
            </svg>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <div class="card-head">
        <h2>Briefing</h2>
        <div class="tabs" role="tablist" aria-label="Areas">
          <button class="tab active" data-sheet="North" role="tab" aria-selected="true">North</button>
          <button class="tab" data-sheet="West" role="tab" aria-selected="false">West</button>
          <button class="tab" data-sheet="East" role="tab" aria-selected="false">East</button>
          <button class="tab" data-sheet="South" role="tab" aria-selected="false">South</button>
        </div>
      </div>

      <div class="toolbar">
        <span class="muted">Excel: <code>./lib/assets/intel/documents/intel.xlsx</code> → Export: <code>./lib/assets/intel/intel.js</code></span>
        <div class="grow"></div>
        <label class="file-pill">
          <input id="file-input" type="file" accept=".js" />
          Load export
        </label>
      </div>

      <div id="intel-feed" class="intel-grid" aria-live="polite"></div>
    </section>
  </main>

  <script src="./lib/assets/intel/intel.js"></script>
  <script>
  (function(){
    if (!window.INTEL_DATA) {
      console.warn('No INTEL_DATA');
      return;
    }
    const feedEl = document.getElementById('intel-feed');
    if (!feedEl) {
      console.warn('#intel-feed missing');
      return;
    }
    const tabs = document.querySelectorAll('.tab');
    const refreshBtn = document.getElementById('btn-refresh');
    const fileInput = document.getElementById('file-input');

    const val = (o, k) => {
      if (!o) return '';
      const direct = o[k];
      if (direct != null && direct !== '') return String(direct);
      const lowerKey = k.toLowerCase();
      const foundEntry = Object.entries(o).find(([key]) => key && key.toLowerCase() === lowerKey);
      if (foundEntry) {
        const [, value] = foundEntry;
        if (value != null) return String(value);
      }
      return '';
    };

    function resolveImgPath(s) {
      if (!s) return 'lib/assets/intel/images/placeholder.png';
      if (s.includes('/') || s.includes('\\')) return s;
      return 'lib/assets/intel/images/' + s;
    }

    function cardHTML(o){
      const vrm   = val(o, 'Vehicle (VRM)') || val(o, 'Vehicle');
      const name  = val(o, 'Name');
      const img   = resolveImgPath(val(o, 'Image (path or URL)') || val(o, 'Image'));
      const ha    = val(o, 'Home Address');
      const loc   = val(o, 'Location (if not H/A)');
      const intel = val(o, 'Intel');
      const results    = val(o, 'Results');
      const priority   = val(o, 'Priority');
      const confidence = val(o, 'Confidence');
      const updatedBy  = val(o, 'Updated By');
      const lastUpd    = val(o, 'Last Updated') || val(o, 'Date Reported');
      const recordId   = val(o, 'Record ID');
      const where = loc || ha;

      const chips = [recordId, results, priority, confidence, o.__region]
        .filter(Boolean)
        .map(c => `<span class="chip">${c}</span>`)
        .join('');

      const title = [vrm, name].filter(Boolean).join(' — ');

      return `
        <article class="intel-card">
          <img class="intel-thumb" src="${img}" alt="">
          <div class="intel-body">
            <h3 class="intel-title">${title || 'Unnamed'}</h3>
            <div class="intel-sub">${where || '&nbsp;'}</div>
            <div class="intel-chips">${chips}</div>
            <div class="intel-text">${intel || '&nbsp;'}</div>
            <div class="intel-foot">Last updated ${lastUpd || '—'} · ${updatedBy || ''}</div>
          </div>
        </article>`;
    }

    const tag = (region, arr) => (Array.isArray(arr) ? arr : []).map(r => ({ ...r, __region: region }));
    const collectItems = (src) => {
      const data = src || {};
      return []
        .concat(tag('North', data.north))
        .concat(tag('West',  data.west))
        .concat(tag('East',  data.east))
        .concat(tag('South', data.south));
    };

    let items = [];
    let activeRegion = 'North';

    function sortItems() {
      items.sort((a, b) => (val(b,'Last Updated') || '').localeCompare(val(a,'Last Updated') || ''));
    }

    function render(region) {
      const list = items.filter(item => !region || item.__region === region);
      feedEl.innerHTML = list.map(cardHTML).join('') || '<div class="intel-empty">No intel available</div>';
    }

    function rebuild(source) {
      items = collectItems(source);
      sortItems();
      render(activeRegion);
    }

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const region = btn.dataset.sheet || btn.textContent || '';
        tabs.forEach(b => {
          const isActive = b === btn;
          b.classList.toggle('active', isActive);
          b.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        activeRegion = region;
        render(region);
      });
    });

    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => rebuild(window.INTEL_DATA));
    }

    if (fileInput) {
      fileInput.addEventListener('change', async (ev) => {
        const file = ev.target.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          new Function(text).call(window);
          rebuild(window.INTEL_DATA);
          alert('Intel data reloaded for this session.');
        } catch (err) {
          console.error(err);
          alert('Unable to load intel data file. Ensure it is the exported intel.js.');
        } finally {
          ev.target.value = '';
        }
      });
    }

    rebuild(window.INTEL_DATA);
  })();
  </script>
</body>
</html>
